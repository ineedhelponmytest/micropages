<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MicroPages</title>
<style>
  body{margin:0;font-family:sans-serif;background:#0f1115;color:#e6eef7;}
  .container{display:flex;height:100vh;}
  .editor, .feed{flex:1;padding:12px;overflow:auto;}
  .editor{background:#0b0c0f;border-right:1px solid #222;}
  .feed{background:#10121a;}
  h1{margin-top:0;font-size:20px;}
  input, textarea, select{width:100%;margin:4px 0;padding:6px;background:#0f1115;border:1px solid #222;color:#e6eef7;border-radius:4px;}
  button{padding:6px 12px;margin:4px 0;border:none;border-radius:4px;background:#24c77b;color:#0b0c0f;cursor:pointer;}
  .page{background:#0b0c0f;padding:8px;margin:8px 0;border-radius:6px;border:1px solid #222;}
  .page-title{font-weight:bold;margin:0;}
  .page-content{margin:4px 0;}
  .small{font-size:12px;color:#9aa3b2;}
  .block{border:1px dashed #222;padding:4px;margin:4px 0;border-radius:4px;display:flex;gap:4px;align-items:center;}
  .block textarea{flex:1;background:#0f1115;border:none;color:#e6eef7;}
  .fullscreen{position:fixed;top:0;left:0;width:100%;height:100%;background:#0f1115;color:#e6eef7;z-index:1000;overflow:auto;padding:12px;display:none;flex-direction:column;}
  .fullscreen button{align-self:flex-end;}
</style>
</head>
<body>

<div class="container">
  <!-- Editor -->
  <div class="editor">
    <h1>Create Page</h1>
    <input type="text" id="title" placeholder="Page Title">
    <div id="blocksContainer"></div>
    <button id="addTextBlock">Add Text Block</button>
    <button id="addImageBlock">Add Image Block</button>
    <button id="createBtn">Create Page</button>
  </div>

  <!-- Feed -->
  <div class="feed">
    <h1>Feed</h1>
    <div id="feedList"></div>
  </div>
</div>

<!-- Fullscreen Page View -->
<div class="fullscreen" id="fullscreenView">
  <button id="closeFullscreen">Back to Feed</button>
  <div id="fullscreenContent"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://jzeoinetgtxfrulujraa.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6ZW9pbmV0Z3R4ZnJ1bHVqcmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MTcxNzAsImV4cCI6MjA4MDk5MzE3MH0.Z0By2zuzpCWqNbH0YIT0vliseXFe1LlRSHsT2dSu4Hs';

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const feedList = document.getElementById('feedList');
const createBtn = document.getElementById('createBtn');
const titleInput = document.getElementById('title');
const blocksContainer = document.getElementById('blocksContainer');

const addTextBlockBtn = document.getElementById('addTextBlock');
const addImageBlockBtn = document.getElementById('addImageBlock');

const fullscreenView = document.getElementById('fullscreenView');
const fullscreenContent = document.getElementById('fullscreenContent');
const closeFullscreen = document.getElementById('closeFullscreen');

let blocks = [];

// Block functions
function renderBlocks(){
  blocksContainer.innerHTML = '';
  blocks.forEach((block, index)=>{
    const div = document.createElement('div');
    div.className = 'block';
    const select = document.createElement('select');
    select.innerHTML = `<option value="text">Text</option><option value="image">Image</option>`;
    select.value = block.type;
    select.onchange = (e)=>{ block.type=e.target.value; renderBlocks(); };

    const textarea = document.createElement('textarea');
    textarea.value = block.value;
    textarea.oninput = (e)=>{ block.value=e.target.value; };

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'X';
    removeBtn.onclick = ()=>{ blocks.splice(index,1); renderBlocks(); };

    div.appendChild(select);
    div.appendChild(textarea);
    div.appendChild(removeBtn);
    blocksContainer.appendChild(div);
  });
}

// Add new blocks
addTextBlockBtn.onclick = ()=>{ blocks.push({type:'text', value:''}); renderBlocks(); };
addImageBlockBtn.onclick = ()=>{ blocks.push({type:'image', value:''}); renderBlocks(); };

// Load feed
async function loadFeed(){
  const { data, error } = await supabase.from('pages').select('*').order('created_at',{ascending:false});
  if(error){ console.error(error); return; }
  feedList.innerHTML = '';
  data.forEach(page=>{
    const div = document.createElement('div');
    div.className = 'page';
    div.innerHTML = `
      <p class="page-title">${page.title||'Untitled'}</p>
      <pre class="page-content">${JSON.stringify(page.content,null,2)}</pre>
      <div style="display:flex;gap:4px;">
        <button class="viewBtn">View</button>
        <button class="remixBtn">Remix</button>
        <button class="likeBtn">Like (${page.likes||0})</button>
      </div>
      <p class="small">${new Date(page.created_at).toLocaleString()}</p>
    `;
    // View button
    div.querySelector('.viewBtn').onclick = ()=>{
      fullscreenContent.innerHTML = `<h2>${page.title}</h2>`;
      page.content.blocks.forEach(b=>{
        if(b.type==='text') fullscreenContent.innerHTML += `<p>${b.value}</p>`;
        else if(b.type==='image') fullscreenContent.innerHTML += `<img src="${b.value}" style="max-width:100%;margin:4px 0;">`;
      });
      fullscreenView.style.display = 'flex';
    }
    // Remix button
    div.querySelector('.remixBtn').onclick = ()=>{
      titleInput.value = page.title + ' (Remix)';
      blocks = JSON.parse(JSON.stringify(page.content.blocks));
      renderBlocks();
    }
    // Like button
    div.querySelector('.likeBtn').onclick = async ()=>{
      const { error } = await supabase.from('pages').update({likes: (page.likes||0)+1 }).eq('id', page.id);
      if(error) console.error(error);
      else loadFeed();
    }

    feedList.appendChild(div);
  });
}

// Close fullscreen
closeFullscreen.onclick = ()=>{ fullscreenView.style.display='none'; };

// Create page
createBtn.onclick = async ()=>{
  if(!titleInput.value){ alert('Enter a title'); return; }
  if(blocks.length===0){ alert('Add at least one block'); return; }

  const { data, error } = await supabase.from('pages').insert([{
    title: titleInput.value,
    content: { blocks },
    likes:0
  }]);
  if(error){ alert(error.message); return; }

  titleInput.value='';
  blocks=[];
  renderBlocks();
  loadFeed();
}

// Initialize
renderBlocks();
loadFeed();

</script>
</body>
</html>
